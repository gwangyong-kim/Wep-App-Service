<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë°”ì¼ ì¬ê³  ê¸°ë¡ ì•± (Google Sheets)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* ëª¨ë°”ì¼ ì¤‘ì•™ ì •ë ¬ ë° ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
        .container-mobile {
            max-width: 420px;
            width: 100%;
            min-height: 100vh;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        input[type="text"], input[type="number"], textarea {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input:focus, textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        .scrollable-list {
            max-height: calc(100vh - 450px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body onload="refreshRecords()">

<div id="app" class="container-mobile flex flex-col">
    <!-- Header -->
    <header class="bg-gray-800 p-4 text-white shadow-lg sticky top-0 z-10 rounded-b-xl">
        <h1 class="text-2xl font-bold text-center">ì¬ê³  ì…ì¶œê³  ê¸°ë¡ (Google Sheets)</h1>
        <p id="user-id-display" class="text-xs text-center mt-1 opacity-75 truncate">
            ë°ì´í„°ë² ì´ìŠ¤: Google Sheets (Apps Script í•„ìš”)
        </p>
    </header>

    <!-- Main Content Area -->
    <main class="p-4 flex-grow overflow-auto">

        <!-- Input Form Section -->
        <section class="mb-6 p-4 border border-gray-200 rounded-xl shadow-md bg-white">
            <h2 class="text-lg font-semibold mb-3 text-gray-700">ìƒˆë¡œìš´ ê±°ë˜ ê¸°ë¡</h2>
            
            <div class="space-y-3">
                <!-- í’ˆëª© (Item) -->
                <div>
                    <label for="item" class="block text-sm font-medium text-gray-700 mb-1">í’ˆëª©</label>
                    <input type="text" id="item" placeholder="ì œí’ˆ ì´ë¦„ ë˜ëŠ” ì½”ë“œ" required>
                </div>

                <!-- ìˆ˜ëŸ‰ (Quantity) -->
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">ìˆ˜ëŸ‰</label>
                    <input type="number" id="quantity" min="1" placeholder="ìˆ˜ëŸ‰ (ìˆ«ìë§Œ)" required>
                </div>

                <!-- ë©”ëª¨ (Memo) -->
                <div>
                    <label for="memo" class="block text-sm font-medium text-gray-700 mb-1">ë©”ëª¨</label>
                    <textarea id="memo" rows="2" placeholder="ì¶”ê°€ ì„¤ëª… (ì„ íƒ ì‚¬í•­)"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-3 mt-4">
                <button onclick="recordTransaction('IN')" 
                        class="flex-1 py-3 px-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] active:scale-95 text-base">
                    ğŸ“¦ ì…ê³  (ì¬ê³  ì¦ê°€)
                </button>
                <button onclick="recordTransaction('OUT')" 
                        class="flex-1 py-3 px-4 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] active:scale-95 text-base">
                    ğŸšš ì¶œê³  (ì¬ê³  ê°ì†Œ)
                </button>
            </div>
            
            <div id="message-box" class="mt-3 text-center text-sm font-medium hidden p-2 rounded-lg" role="alert"></div>
            
            <div id="loading-indicator" class="mt-3 flex justify-center hidden">
                <div class="spinner"></div>
                <span class="ml-2 text-gray-600">ì²˜ë¦¬ ì¤‘...</span>
            </div>
        </section>

        <!-- Record List Section -->
        <section class="mt-6">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold text-gray-800">ì „ì²´ ê¸°ë¡ <span id="record-count" class="text-sm font-medium text-gray-500">(0ê±´)</span></h2>
                <button onclick="refreshRecords()" class="flex items-center text-sm text-blue-600 hover:text-blue-800 font-semibold py-1 px-3 rounded-full bg-blue-50 transition duration-150">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H20M4 12v5h.582m15.356 2A8.001 8.001 0 004.582 15m15.356 2H20"></path></svg>
                    ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
            
            <div id="records-list" class="space-y-3 scrollable-list">
                <!-- Records will be inserted here -->
                <p id="initial-loading-message" class="text-center text-gray-500 p-4">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ 'ìƒˆë¡œê³ ì¹¨' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            </div>
        </section>

    </main>
</div>

<script>
    // ----------------------------------------------------------------------
    // âš ï¸ ì¤‘ìš”: ì´ URLì„ Google Apps Script ë°°í¬ í›„ ì–»ê²Œ ë˜ëŠ” ì‹¤ì œ URLë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCf-gnZQbzGMluSOYIuZrk_qpLQ0IT4hNrDT6UeTHSCLYdqKHcGvelyMZprtTCef5f/exec"; 
    // ----------------------------------------------------------------------
    
    const MESSAGE_DURATION = 3000;

    // 2. ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(message, type = 'success') {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
        
        if (type === 'error') {
            msgBox.classList.add('bg-red-100', 'text-red-700');
        } else {
            msgBox.classList.add('bg-green-100', 'text-green-700');
        }

        setTimeout(() => {
            msgBox.classList.add('hidden');
        }, MESSAGE_DURATION);
    }

    // 3. ë¡œë”© ìƒíƒœ í† ê¸€ í•¨ìˆ˜
    function toggleLoading(isLoading) {
        document.getElementById('loading-indicator').classList.toggle('hidden', !isLoading);
        document.querySelectorAll('button').forEach(btn => btn.disabled = isLoading);
    }

    // 4. ë°ì´í„° ê¸°ë¡ (POST)
    window.recordTransaction = async function(type) {
        if (APPS_SCRIPT_URL === "YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE") {
             showMessage("âš ï¸ Google Apps Script URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.", 'error');
             return;
        }

        const itemInput = document.getElementById('item');
        const quantityInput = document.getElementById('quantity');
        const memoInput = document.getElementById('memo');

        const item = itemInput.value.trim();
        const quantity = parseInt(quantityInput.value, 10);
        const memo = memoInput.value.trim();

        if (!item) {
            showMessage("í’ˆëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');
            return;
        }
        if (isNaN(quantity) || quantity <= 0) {
            showMessage("ìœ íš¨í•œ ìˆ˜ëŸ‰(1 ì´ìƒ)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');
            return;
        }

        toggleLoading(true);

        try {
            const recordData = {
                action: 'add', // Apps Scriptì— ë³´ë‚¼ ì•¡ì…˜ ì§€ì •
                item: item,
                quantity: quantity,
                type: type, // 'IN' ë˜ëŠ” 'OUT'
                memo: memo,
            };

            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(recordData)
            });

            const result = await response.json();

            if (result.status === 'success') {
                // ì„±ê³µ ì‹œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                itemInput.value = '';
                quantityInput.value = '';
                memoInput.value = '';
                
                showMessage(`${item} ${type === 'IN' ? 'ì…ê³ ' : 'ì¶œê³ '} ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. Sheetsì—ì„œ í™•ì¸í•˜ì„¸ìš”!`, 'success');
                
                // ê¸°ë¡ ì¶”ê°€ í›„ ë°”ë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                await refreshRecords(); 
            } else {
                showMessage(`ê¸°ë¡ ì¶”ê°€ ì‹¤íŒ¨: ${result.message || 'Apps Script ì˜¤ë¥˜'}`, 'error');
            }

        } catch (error) {
            console.error("ê±°ë˜ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:", error);
            showMessage(`ê¸°ë¡ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” Apps Script ì„¤ì • ì˜¤ë¥˜`, 'error');
        } finally {
            toggleLoading(false);
        }
    }

    // 5. ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (GET)
    window.refreshRecords = async function() {
        if (APPS_SCRIPT_URL === "YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE") {
             showMessage("âš ï¸ Google Apps Script URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.", 'error');
             return;
        }

        toggleLoading(true);
        const listElement = document.getElementById('records-list');
        listElement.innerHTML = `<p id="initial-loading-message" class="text-center text-gray-500 p-4">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;


        try {
            // GET ìš”ì²­ìœ¼ë¡œ 'action=get'ì„ í¬í•¨í•˜ì—¬ ëª¨ë“  ê¸°ë¡ì„ ìš”ì²­
            const response = await fetch(`${APPS_SCRIPT_URL}?action=get`);
            const result = await response.json();

            if (result.status === 'success' && Array.isArray(result.data)) {
                // ë°ì´í„°ëŠ” Apps Scriptì—ì„œ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ë„˜ì–´ì˜¬ ê²ƒìœ¼ë¡œ ê°€ì •
                displayRecords(result.data);
                showMessage(`ì´ ${result.data.length}ê±´ì˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
            } else {
                 throw new Error(result.message || 'Apps Scriptì—ì„œ ìœ íš¨í•œ ë°ì´í„°ê°€ ë°˜í™˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }

        } catch (error) {
            console.error("ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
            listElement.innerHTML = `<p class="text-center text-red-500 p-4">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” Apps Script ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</p>`;
        } finally {
            toggleLoading(false);
        }
    }


    // 6. ê¸°ë¡ í‘œì‹œ í•¨ìˆ˜ (Google Sheets ë°ì´í„° í˜•ì‹ì— ë§ê²Œ ìˆ˜ì •)
    function displayRecords(records) {
        const listElement = document.getElementById('records-list');
        const countElement = document.getElementById('record-count');
        
        listElement.innerHTML = '';
        countElement.textContent = `(${records.length}ê±´)`;

        if (records.length === 0) {
            listElement.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-gray-500 text-base">ì•„ì§ ê¸°ë¡ëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-gray-400 text-sm mt-1">ìœ„ì— ì…ë ¥ í¼ì„ ì‚¬ìš©í•˜ì—¬ ì²« ê±°ë˜ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>
                </div>
            `;
            return;
        }

        // records ë°°ì—´ì€ Google Sheetsì—ì„œ ì˜¨ ë°ì´í„° (ì˜ˆ: ['2023-11-15 14:30', 'IN', 'ë…¸íŠ¸ë¶', 5, 'ìƒˆ í”„ë¡œì íŠ¸ ë¬¼í’ˆ'])
        records.forEach(record => {
            if (record.length < 5) return; // ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° ê±´ë„ˆë›°ê¸°
            
            const [timestampStr, type, item, quantity, memo] = record;

            const isIN = type === 'IN';
            const typeText = isIN ? 'ì…ê³ ' : 'ì¶œê³ ';
            const colorClass = isIN ? 'bg-green-100 text-green-700 border-green-300' : 'bg-red-100 text-red-700 border-red-300';
            const sign = isIN ? '+' : '-';
            
            // ì‹œíŠ¸ì—ì„œ ê°€ì ¸ì˜¨ íƒ€ì„ìŠ¤íƒ¬í”„ ë¬¸ìì—´ì„ í‘œì‹œ
            const dateTimeStr = timestampStr ? timestampStr : 'ì‹œê°„ ì •ë³´ ì—†ìŒ';

            const itemHtml = `
                <div class="flex justify-between items-center p-4 border rounded-xl shadow-sm ${colorClass}">
                    <!-- Left: Item Name and Timestamp -->
                    <div class="flex-1 min-w-0">
                        <p class="text-lg font-bold truncate">${item}</p>
                        <p class="text-xs text-gray-500 mt-0.5">${dateTimeStr}</p>
                        ${memo ? `<p class="text-sm text-gray-600 mt-1 italic break-words whitespace-normal">ë©”ëª¨: ${memo}</p>` : ''}
                    </div>
                    
                    <!-- Right: Type and Quantity -->
                    <div class="text-right ml-4">
                        <span class="inline-block text-xs font-semibold px-2 py-0.5 rounded-full ${isIN ? 'bg-green-500' : 'bg-red-500'} text-white">
                            ${typeText}
                        </span>
                        <p class="text-xl font-extrabold mt-1 ${isIN ? 'text-green-700' : 'text-red-700'}">
                            ${sign}${Number(quantity).toLocaleString()}
                        </p>
                    </div>
                </div>
            `;
            listElement.insertAdjacentHTML('beforeend', itemHtml);
        });
    }

</script>
</body>
</html>
