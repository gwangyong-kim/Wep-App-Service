<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>엑셀 업로더</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background: #f6f8fa; font-family: Arial, sans-serif; }
        #message-box {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; display: none; color: white;
            font-weight: bold;
        }
        .success { background: #16a34a; }
        .error { background: #dc2626; }
    </style>
</head>

<body class="p-6">

<div class="max-w-3xl mx-auto bg-white shadow-lg p-6 rounded-lg">

    <h1 class="text-2xl font-bold mb-4">엑셀 → 구글 시트 업로더</h1>

    <!-- 1. 파일 선택 -->
    <input id="fileInput" type="file" accept=".xlsx,.xls,.csv"
           class="mb-4"
           onchange="loadExcel(event)">

    <p id="fileName" class="text-sm text-gray-600 mb-4"></p>

    <!-- 2. 시트 선택 -->
    <select id="sheetSelect" class="p-2 border rounded mb-4 bg-white" disabled>
        <option>시트 목록 로딩중...</option>
    </select>

    <!-- 3. 업로드 버튼 -->
    <button id="uploadBtn"
            class="w-full bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700 disabled:bg-gray-400"
            onclick="uploadData()" disabled>
        업로드
    </button>

    <!-- 미리보기 -->
    <h2 class="text-xl font-semibold mt-6 mb-3">미리보기 (상위 10행)</h2>
    <div class="overflow-x-auto max-h-96 border rounded">
        <table id="previewTable" class="w-full text-sm"></table>
    </div>

</div>

<div id="message-box"></div>

<script>
const GAS_URL = "YOUR_WEB_APP_URL";   // 네가 사용하던 GitHub 방식 그대로

let extractedData = [];

// 메시지 표시
function showMsg(msg, type="success") {
    const box = document.getElementById("message-box");
    box.className = type;
    box.textContent = msg;
    box.style.display = "block";

    setTimeout(() => box.style.display = "none", 3000);
}

// 1. 엑셀 로드
function loadExcel(e) {
    const file = e.target.files[0];
    if (!file) return;

    document.getElementById("fileName").textContent = "선택된 파일: " + file.name;

    const reader = new FileReader();
    reader.onload = function(evt) {
        const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        extractedData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        previewTable(extractedData);
        document.getElementById("uploadBtn").disabled = false;
    };
    reader.readAsArrayBuffer(file);
}

// 미리보기
function previewTable(data) {
    const table = document.getElementById("previewTable");
    table.innerHTML = "";

    if (data.length === 0) return;

    const rows = data.slice(0, 10);
    rows.forEach((row, i) => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
            const td = document.createElement(i === 0 ? "th" : "td");
            td.className = "border p-2";
            td.textContent = cell ?? "";
            tr.appendChild(td);
        });
        table.appendChild(tr);
    });
}

// 2. 시트 이름 로드
async function loadSheetNames() {
    const select = document.getElementById("sheetSelect");
    try {
        const res = await fetch(GAS_URL);
        const json = await res.json();

        if (!json.success) throw json.error;

        select.innerHTML = "";
        json.sheetNames.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

        select.disabled = false;

    } catch (err) {
        select.innerHTML = "<option>로드 실패</option>";
    }
}

// 3. 업로드
async function uploadData() {
    const sheetName = document.getElementById("sheetSelect").value;

    if (!sheetName) {
        showMsg("시트를 선택하세요", "error");
        return;
    }

    try {
        const res = await fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify({ data: extractedData, sheetName })
        });

        const json = await res.json();

        if (json.success)
            showMsg(`업로드 완료! ${json.rowsWritten}행 반영`, "success");
        else
            showMsg(json.error, "error");

    } catch (err) {
        showMsg("업로드 오류: " + err.message, "error");
    }
}

window.onload = loadSheetNames;
</script>
</body>
</html>
