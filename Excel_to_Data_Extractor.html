<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—‘ì…€ ë°ì´í„° ì¶”ì¶œ ë° ì—…ë¡œë”</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (ì—‘ì…€ íŒŒì¼ íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- MarkedJS (Gemini APIì˜ Markdown ì¶œë ¥ì„ HTMLë¡œ ë³€í™˜) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* ìƒíƒœ ë©”ì‹œì§€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        #message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            font-weight: 600;
            transition: opacity 0.3s ease-in-out;
        }
        .success {
            background-color: #10b981; /* green-500 */
            color: white;
        }
        .error {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .info {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">
            ì—‘ì…€ to êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë” (Gemini ìë™ ë¶„ì„ í¬í•¨)
        </h1>
        <p class="text-gray-600 mb-8">
            ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ê³ , Geminiì˜ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•œ í›„, ì„ íƒëœ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
        </p>

        <!-- ë‹¨ê³„ë³„ ì»¨í…Œì´ë„ˆ -->
        <div class="space-y-8">

            <!-- 0ë‹¨ê³„: API Key ì„¤ì • (ì½”ë“œë¡œ í†µí•©) -->
            <div id="setup-step" class="p-5 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h2 class="text-xl font-semibold text-yellow-800 mb-2">âœ… ì„¤ì • ì™„ë£Œ (ì½”ë“œ ë‚´ë¶€ í†µí•©)</h2>
                <p class="text-sm text-yellow-700">Gemini API Keyì™€ Google Apps Script URLì€ ì´ ì›¹ ì•±ì˜ JavaScript ì½”ë“œ ë‚´ë¶€ì— ì§ì ‘ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ì‹¤í–‰ ì „ ì½”ë“œ í™•ì¸ í•„ìˆ˜)</p>
            </div>


            <!-- 1ë‹¨ê³„: ì—‘ì…€ íŒŒì¼ ë¡œë“œ -->
            <div id="load-step" class="p-5 bg-indigo-50 border border-indigo-200 rounded-lg">
                <h2 class="text-xl font-semibold text-indigo-800 mb-4">1ë‹¨ê³„: ì—‘ì…€ íŒŒì¼ ë¡œë“œ</h2>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-500 file:text-white
                    hover:file:bg-indigo-600" onchange="loadExcelFile(event)">
                <p id="fileNameDisplay" class="mt-3 text-sm text-gray-700"></p>
                <div id="loadingIndicator" class="hidden mt-3 text-indigo-600 font-semibold flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>íŒŒì¼ì„ ì½ëŠ” ì¤‘...</span>
                </div>
            </div>
            
            <!-- 2ë‹¨ê³„: ëŒ€ìƒ ì‹œíŠ¸ ì„ íƒ -->
            <div id="select-sheet-step" class="p-5 bg-purple-50 border border-purple-200 rounded-lg">
                <h2 class="text-xl font-semibold text-purple-800 mb-4">2ë‹¨ê³„: ëŒ€ìƒ ì‹œíŠ¸ ì„ íƒ</h2>
                <label for="sheetNameSelect" class="block text-sm font-medium text-gray-700 mb-2">êµ¬ê¸€ ì‹œíŠ¸ì˜ ëŒ€ìƒ ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:</label>
                <select id="sheetNameSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-purple-500 focus:ring-purple-500" disabled>
                    <option value="" disabled selected>ì‹œíŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
                <p id="sheetLoadStatus" class="mt-2 text-sm text-gray-500"></p>
            </div>

            <!-- 3ë‹¨ê³„: ìë™ ë¶„ì„ ë° ì „ì†¡ ìƒíƒœ -->
            <div id="process-step" class="p-5 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">3ë‹¨ê³„: ë°ì´í„° ìë™ ë¶„ì„ ë° ì „ì†¡</h2>
                <p id="autoProcessStatus" class="text-base text-blue-700">íŒŒì¼ ë¡œë“œ í›„ ìë™ ë¶„ì„ ë° ì „ì†¡ì„ ëŒ€ê¸°í•©ë‹ˆë‹¤.</p>
                <div id="processIndicator" class="hidden mt-3 text-blue-600 font-semibold flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="currentProcessMessage">ìë™ ë¶„ì„ ì§„í–‰ ì¤‘...</span>
                </div>
            </div>

        </div>

        <!-- Gemini ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ -->
        <div id="analysisResultSection" class="mt-10 p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-3 flex items-center">
                âœ¨ Gemini ë°ì´í„° ë¶„ì„ ê²°ê³¼
            </h2>
            <div id="analysisResult" class="prose max-w-none text-gray-700 text-sm overflow-x-auto">
                <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
            </div>
        </div>

        <!-- ì—‘ì…€ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
        <div id="previewSection" class="mt-10 p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-3">
                ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 10í–‰)
            </h2>
            <div class="overflow-x-auto max-h-96">
                <table id="dataTable" class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-200 sticky top-0">
                        <!-- í—¤ë”ëŠ” JSì—ì„œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        <!-- ë°ì´í„°ëŠ” JSì—ì„œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- ìƒíƒœ ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="message-box" class="opacity-0"></div>

    <script>
        // =======================================================================
        // ğŸš¨ ì‚¬ìš©ì ì„¤ì •: ì—¬ê¸°ì— API Keyì™€ GAS URLì„ ë„£ì–´ì£¼ì„¸ìš”!
        // =======================================================================
        // 1. Gemini API Key (Gemini ë¶„ì„ì— í•„ìš”)
        const API_KEY = "YOUR_GEMINI_API_KEY_HERE";
        // 2. Google Apps Script ì›¹ ì•± URL (ë°ì´í„° ì „ì†¡ì— í•„ìš”)
        const GAS_WEB_APP_URL = "YOUR_GAS_WEB_APP_URL_HERE";

        // =======================================================================
        // ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
        // =======================================================================
        let extractedData = [];
        let isFileLoaded = false;
        let isAnalysisDone = false;

        // =======================================================================
        // UI ìœ í‹¸ë¦¬í‹°
        // =======================================================================

        function showMessageBox(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.className = ''; // ê¸°ì¡´ í´ë˜ìŠ¤ ì´ˆê¸°í™”
            box.classList.add(type);
            box.classList.add('opacity-100');
            box.innerText = message;
            box.style.display = 'block';

            // 4ì´ˆ í›„ ì‚¬ë¼ì§€ë„ë¡ ì„¤ì •
            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => {
                    box.style.display = 'none';
                }, 300); // fade out ì‹œê°„
            }, 4000);
        }

        function updateProcessIndicator(message, isWorking = true) {
            const indicator = document.getElementById('processIndicator');
            const messageEl = document.getElementById('currentProcessMessage');
            
            messageEl.innerText = message;
            if (isWorking) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }
        
        // =======================================================================
        // 1ë‹¨ê³„: ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        // =======================================================================

        function loadExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').innerText = `ì„ íƒëœ íŒŒì¼: ${file.name}`;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('analysisResultSection').classList.add('hidden');
            isFileLoaded = false;
            isAnalysisDone = false;
            updateProcessIndicator('íŒŒì¼ ë¡œë“œ ì¤€ë¹„ ì¤‘...', true);

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // ì²« ë²ˆì§¸ ì‹œíŠ¸ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // ë°ì´í„°ë¥¼ ë°°ì—´ì˜ ë°°ì—´ (AOA: Array of Arrays) í˜•íƒœë¡œ ë³€í™˜
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length === 0) {
                        showMessageBox('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }

                    extractedData = jsonData;
                    displayDataPreview(extractedData);
                    isFileLoaded = true;
                    
                    showMessageBox(`âœ… íŒŒì¼ ë¡œë“œ ì„±ê³µ: ${extractedData.length}í–‰ ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ`, 'success');

                    // íŒŒì¼ ë¡œë“œ ì„±ê³µ í›„, ë°”ë¡œ ìë™ ë¶„ì„ ì‹œì‘
                    updateProcessIndicator('íŒŒì¼ ë¡œë“œ ì™„ë£Œ. Gemini ìë™ ë¶„ì„ ì‹œì‘...', true);
                    await analyzeData(extractedData);

                    // ë¶„ì„ ì™„ë£Œ í›„, ë°”ë¡œ ì „ì†¡ ì‹œì‘
                    if (isAnalysisDone) {
                        updateProcessIndicator('ë¶„ì„ ì™„ë£Œ. êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ì‹œì‘...', true);
                        await uploadDataToSheets(extractedData);
                    }


                } catch (error) {
                    showMessageBox(`âŒ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                    console.error("íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                } finally {
                    document.getElementById('loadingIndicator').classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayDataPreview(data) {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const thead = table.querySelector('thead');
            
            // í…Œì´ë¸” ì´ˆê¸°í™”
            tbody.innerHTML = '';
            thead.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('previewSection').classList.add('hidden');
                return;
            }

            // í—¤ë” ìƒì„± (ì²« í–‰)
            const headerRow = data[0];
            const headerHtml = `<tr>${headerRow.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h || ''}</th>`).join('')}</tr>`;
            thead.innerHTML = headerHtml;

            // ë°ì´í„° í–‰ ìƒì„± (ìµœëŒ€ 10í–‰)
            const rows = data.slice(1, 11); // í—¤ë” ì œì™¸í•˜ê³  10ê°œë§Œ ë¯¸ë¦¬ë³´ê¸°
            rows.forEach(row => {
                const rowHtml = `<tr>${row.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${cell === null || cell === undefined ? '' : cell}</td>`).join('')}</tr>`;
                tbody.innerHTML += rowHtml;
            });

            document.getElementById('previewSection').classList.remove('hidden');
        }

        // =======================================================================
        // 2ë‹¨ê³„: ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰)
        // =======================================================================

        async function fetchSheetNames() {
            const selectEl = document.getElementById('sheetNameSelect');
            const statusEl = document.getElementById('sheetLoadStatus');
            selectEl.disabled = true;

            if (GAS_WEB_APP_URL === "YOUR_GAS_WEB_APP_URL_HERE" || !GAS_WEB_APP_URL) {
                statusEl.innerHTML = '<span class="text-red-500 font-semibold">âŒ GAS URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½”ë“œ ë‚´ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.</span>';
                selectEl.innerHTML = '<option value="" disabled selected>GAS URL ë¯¸ì„¤ì •</option>';
                return;
            }
            
            statusEl.innerText = 'êµ¬ê¸€ ì‹œíŠ¸ì˜ ì‹œíŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';

            try {
                // GAS ì›¹ ì•±ì— GET ìš”ì²­ì„ ë³´ëƒ„
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && Array.isArray(result.sheetNames)) {
                    selectEl.innerHTML = '';
                    result.sheetNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.innerText = name;
                        selectEl.appendChild(option);
                    });
                    selectEl.disabled = false;
                    statusEl.innerHTML = `<span class="text-green-600">âœ… ì‹œíŠ¸ ëª©ë¡ ${result.sheetNames.length}ê°œ ë¡œë“œ ì™„ë£Œ.</span>`;
                    // ì²« ë²ˆì§¸ ì‹œíŠ¸ë¥¼ ê¸°ë³¸ ì„ íƒ
                    if (result.sheetNames.length > 0) {
                        selectEl.value = result.sheetNames[0];
                    }
                } else {
                    throw new Error(result.error || "GAS ì„œë²„ì—ì„œ ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.");
                }

            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-500 font-semibold">âŒ ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜: ${error.message}. GAS ê¶Œí•œ ë° URLì„ í™•ì¸í•˜ì„¸ìš”.</span>`;
                console.error("ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
                selectEl.innerHTML = '<option value="" disabled selected>ì˜¤ë¥˜ë¡œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</option>';
            }
        }

        // =======================================================================
        // 3ë‹¨ê³„: Gemini ë¶„ì„ (ìë™ ì‹¤í–‰)
        // =======================================================================

        // ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•˜ëŠ” fetch ë˜í¼ í•¨ìˆ˜ (API ì•ˆì •ì„± í–¥ìƒ)
        async function fetchWithBackoff(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) { // 429 Too Many Requests
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw error;
                }
            }
            throw new Error("API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼).");
        }
        
        async function analyzeData(data) {
            isAnalysisDone = false;
            document.getElementById('analysisResultSection').classList.add('hidden');
            const resultEl = document.getElementById('analysisResult');
            resultEl.innerHTML = '<p>ë°ì´í„° ë¶„ì„ì„ ìœ„í•´ Gemini APIì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            
            if (API_KEY === "YOUR_GEMINI_API_KEY_HERE" || !API_KEY) {
                showMessageBox("âŒ Gemini API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¶„ì„ì„ ê±´ë„ˆëœë‹ˆë‹¤.", 'error');
                isAnalysisDone = true; // ë¶„ì„ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬
                return;
            }

            // ë¶„ì„ì„ ìœ„í•´ ë°ì´í„° ìƒìœ„ 50í–‰ë§Œ ìƒ˜í”Œë§
            const sampleData = data.slice(0, 50);
            const dataString = JSON.stringify(sampleData);
            
            const systemPrompt = `ë‹¹ì‹ ì€ ë°ì´í„° í’ˆì§ˆ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ JSON ë°ì´í„° ìƒ˜í”Œì„ ë¶„ì„í•˜ì—¬ í•œêµ­ì–´ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ë¶„ì„ ë‚´ìš©ì€ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ Markdown í¬ë§·ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.`;
            const userQuery = `ë‹¤ìŒì€ ì—‘ì…€ì—ì„œ ì¶”ì¶œëœ ë°ì´í„°ì˜ ìƒìœ„ 50ê°œ í–‰ì˜ JSON ë¬¸ìì—´ì…ë‹ˆë‹¤. ì´ ë°ì´í„°ì˜ íŠ¹ì§•, ê° ì—´ì˜ ì˜ˆìƒ ë°ì´í„° ìœ í˜•(ë¬¸ìì—´, ìˆ«ì, ë‚ ì§œ ë“±), ê·¸ë¦¬ê³  êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë“œ ì „ì— ì •ë¦¬í•´ì•¼ í•  ì ì¬ì ì¸ ë¬¸ì œì (ì˜ˆ: ë¹ˆ ê°’, ì¼ê´€ì„± ì—†ëŠ” í˜•ì‹, í—¤ë” ëˆ„ë½ ë“±)ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”. ë°ì´í„°: ${dataString}`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                updateProcessIndicator('Gemini ëª¨ë¸ì´ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...', true);
                
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}. API í‚¤ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    // Markdownì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
                    // MarkedJSê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ì— ëŒ€ë¹„í•˜ì—¬ ì˜¤ë¥˜ ì²˜ë¦¬ê°€ í•„ìš”í•˜ì§€ë§Œ,
                    // ì¼ë‹¨ CDN ë§í¬ë¥¼ ìµœì‹ ìœ¼ë¡œ êµì²´í•˜ì—¬ marked is not defined ì˜¤ë¥˜ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
                    resultEl.innerHTML = marked.parse(text);
                    document.getElementById('analysisResultSection').classList.remove('hidden');
                    showMessageBox('âœ¨ ë°ì´í„° ë¶„ì„ ì„±ê³µ: ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'info');
                    isAnalysisDone = true;
                } else {
                    throw new Error("Gemini ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

            } catch (error) {
                resultEl.innerHTML = `<p class="text-red-600 font-semibold">âŒ ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ: ${error.message}.</p>`;
                document.getElementById('analysisResultSection').classList.remove('hidden');
                showMessageBox(`âŒ ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                isAnalysisDone = false; // ë¶„ì„ ì‹¤íŒ¨ë¡œ ì „ì†¡ ì¤‘ë‹¨
            } finally {
                updateProcessIndicator('ë¶„ì„ ì™„ë£Œ.', false);
            }
        }

        // =======================================================================
        // 4ë‹¨ê³„: êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ (ìë™ ì‹¤í–‰)
        // =======================================================================
        
        async function uploadDataToSheets(data) {
            if (!isAnalysisDone) {
                showMessageBox("âŒ ë¶„ì„ ê³¼ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ì „ì†¡ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.", 'error');
                updateProcessIndicator('ì „ì†¡ ì¤‘ë‹¨: ë¶„ì„ ì‹¤íŒ¨.', false);
                return;
            }

            const sheetName = document.getElementById('sheetNameSelect').value;

            if (!sheetName) {
                showMessageBox("âŒ ëŒ€ìƒ ì‹œíŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", 'error');
                updateProcessIndicator('ì „ì†¡ ì¤‘ë‹¨: ì‹œíŠ¸ ë¯¸ì„ íƒ.', false);
                return;
            }

            if (GAS_WEB_APP_URL === "YOUR_GAS_WEB_APP_URL_HERE" || !GAS_WEB_APP_URL) {
                showMessageBox("âŒ GAS URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½”ë“œ ë‚´ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.", 'error');
                updateProcessIndicator('ì „ì†¡ ì¤‘ë‹¨: GAS URL ë¯¸ì„¤ì •.', false);
                return;
            }

            if (data.length === 0) {
                showMessageBox("âŒ ì „ì†¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", 'error');
                updateProcessIndicator('ì „ì†¡ ì¤‘ë‹¨: ë°ì´í„° ì—†ìŒ.', false);
                return;
            }

            const payload = {
                data: data,
                sheetName: sheetName
            };

            // CORS ìš°íšŒë¥¼ ìœ„í•´ Content-Type í—¤ë”ë¥¼ ì œê±°í•˜ê³  JSON ë¬¸ìì—´ì„ ë³¸ë¬¸ì— ë‹´ì•„ ë³´ëƒ„.
            const finalJson = JSON.stringify(payload);
            console.log("ì „ì†¡í•  JSON ë¬¸ìì—´:", finalJson.substring(0, 200) + '...'); // ë¡œê·¸ í™•ì¸ìš©

            try {
                updateProcessIndicator(`ë°ì´í„°ë¥¼ '${sheetName}' ì‹œíŠ¸ë¡œ ì „ì†¡ ì¤‘...`, true);
                
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    // headers: { 'Content-Type': 'application/json' }, // CORS ìš°íšŒ ëª©ì ìœ¼ë¡œ í—¤ë” ì œê±°
                    body: finalJson
                });

                // GASì˜ 401 Unauthorized ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤.
                if (response.status === 401) {
                    throw new Error("401 Unauthorized. íšŒì‚¬ ê³„ì •ì˜ GAS ì•¡ì„¸ìŠ¤ ëŒ€ìƒì´ 'ëª¨ë“  ì‚¬ìš©ì(Anyone)'ì¸ì§€ í™•ì¸í•˜ê±°ë‚˜ ë¡œì»¬ ì„œë²„ë¥¼ í†µí•´ ì‹¤í–‰í•˜ì„¸ìš”.");
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log("GAS ì‘ë‹µ Raw Data:", result);

                if (result.success) {
                    showMessageBox(`âœ… ë°ì´í„° ì „ì†¡ ì„±ê³µ! '${result.sheetName}' ì‹œíŠ¸ì— ${result.rowsAppended}í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    throw new Error(result.error || "ì•Œ ìˆ˜ ì—†ëŠ” GAS ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
                }

            } catch (error) {
                showMessageBox(`âŒ ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜: ${error.message}. GAS ê¶Œí•œ ë° URLì„ í™•ì¸í•˜ì„¸ìš”.`, 'error');
                console.error("Fetch ì˜¤ë¥˜:", error);
            } finally {
                updateProcessIndicator('ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ.', false);
            }
        }

        // =======================================================================
        // ì´ˆê¸° ë¡œë“œ
        // =======================================================================
        window.onload = function() {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œíŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ ì‹¤í–‰
            fetchSheetNames();
        };

    </script>
</body>
</html>
