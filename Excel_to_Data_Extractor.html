<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì—‘ì…€ to êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë”</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS (ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸°ìš©) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* ìƒíƒœ ë©”ì‹œì§€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        #message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            font-weight: 600;
            transition: opacity 0.3s ease-in-out;
        }
        .success { background-color: #10b981; color: white; }
        .error { background-color: #ef4444; color: white; }
        .info { background-color: #3b82f6; color: white; }
    </style>
</head>

<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">
            ì—‘ì…€ to êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë”
        </h1>
        <p class="text-gray-600 mb-8">
            ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ë‚´ìš©ì„ ë¯¸ë¦¬ í™•ì¸í•˜ê³ , ì„ íƒí•œ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë¹ ë¥´ê²Œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
        </p>

        <div class="space-y-8">

            <!-- 1ë‹¨ê³„: íŒŒì¼ ë¡œë“œ -->
            <div class="p-5 bg-indigo-50 border border-indigo-200 rounded-lg">
                <h2 class="text-xl font-semibold text-indigo-800 mb-4">1ë‹¨ê³„: ì—‘ì…€ íŒŒì¼ ì„ íƒ</h2>

                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv"
                    class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-500 file:text-white
                    hover:file:bg-indigo-600"
                    onchange="handleExcelFile(event)" />

                <p id="fileNameDisplay" class="mt-3 text-sm text-gray-700"></p>
                <div id="loadingIndicator" class="hidden mt-3 text-indigo-600 font-semibold flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5"
                         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10"
                                stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2
                                  5.291A7.962 7.962 0 014 12H0c0 3.042 1.135
                                  5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>íŒŒì¼ì„ ì½ëŠ” ì¤‘...</span>
                </div>
            </div>

            <!-- 2ë‹¨ê³„: ëŒ€ìƒ ì‹œíŠ¸ ì„ íƒ -->
            <div class="p-5 bg-purple-50 border border-purple-200 rounded-lg">
                <h2 class="text-xl font-semibold text-purple-800 mb-4">2ë‹¨ê³„: ëŒ€ìƒ ì‹œíŠ¸ ì„ íƒ</h2>
                <select id="sheetNameSelect"
                        class="block w-full rounded-md border p-2 bg-white shadow-sm"
                        disabled>
                    <option value="">ì‹œíŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
                <p id="sheetLoadStatus" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- 3ë‹¨ê³„: ì—…ë¡œë“œ -->
            <div class="p-5 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">3ë‹¨ê³„: ì—…ë¡œë“œ</h2>

                <button id="uploadButton"
                        onclick="uploadExcelFile()"
                        class="w-full py-3 px-4 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled>
                    âœ… êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì—…ë¡œë“œ
                </button>

                <div id="processIndicator" class="hidden mt-3 text-blue-600 font-medium flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5"
                         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10"
                                stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0
                                  12h4zm2 5.291A7.962 7.962 0 014
                                  12H0c0 3.042 1.135 5.824 3
                                  7.938l3-2.647z">
                        </path>
                    </svg>
                    <span id="currentProcessMessage">ì „ì†¡ ì¤€ë¹„ ì¤‘...</span>
                </div>
            </div>

        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° -->
        <div id="previewSection" class="mt-10 p-6 bg-gray-50 border rounded-xl hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-3">ğŸ“„ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 10í–‰)</h2>
            <div class="overflow-x-auto max-h-96">
                <table id="dataTable" class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-200 sticky top-0"></thead>
                    <tbody class="divide-y divide-gray-200 bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="message-box"></div>

<script>
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzpnyc43emFxx5UDR35S0GhfyDorpNzfwPAgqN0W3x5jwAlYR_BAh7JEAv-WpHktm3u/exec";

    let extractedData = [];
    let selectedFile = null;

    /***************************************************
     * 1) ì—‘ì…€ íŒŒì¼ ì„ íƒ + ë¯¸ë¦¬ë³´ê¸° ìƒì„± (SheetJS ì‚¬ìš©)
     ***************************************************/
    function handleExcelFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        selectedFile = file;

        document.getElementById('uploadButton').disabled = true;
        document.getElementById('fileNameDisplay').innerText = `ğŸ“‚ ì„ íƒëœ íŒŒì¼: ${file.name}`;
        document.getElementById('loadingIndicator').classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                extractedData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                createPreview(extractedData);

                showMessage("âœ… íŒŒì¼ ë¡œë“œ ì„±ê³µ!", "success");
                document.getElementById('uploadButton').disabled = false;
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function createPreview(data) {
        const tableHead = document.querySelector("#dataTable thead");
        const tableBody = document.querySelector("#dataTable tbody");

        tableHead.innerHTML = "";
        tableBody.innerHTML = "";

        if (data.length === 0) return;

        // í—¤ë”
        const headerRow = data[0];
        tableHead.innerHTML = `<tr>${headerRow
            .map(h => `<th class="px-3 py-2 text-left font-medium">${h || ""}</th>`)
            .join("")}</tr>`;

        // ìƒìœ„ 10í–‰
        data.slice(1, 11).forEach(row => {
            const rowHtml = `<tr>${row
                .map(c => `<td class="px-3 py-1 text-sm">${c ?? ""}</td>`)
                .join("")}</tr>`;
            tableBody.innerHTML += rowHtml;
        });

        document.getElementById("previewSection").classList.remove("hidden");
    }

    /***************************************************
     * 2) ì‹œíŠ¸ ëª©ë¡ ë¡œë”©
     ***************************************************/
    async function fetchSheetNames() {
        const select = document.getElementById("sheetNameSelect");
        const status = document.getElementById("sheetLoadStatus");

        try {
            const res = await fetch(GAS_WEB_APP_URL);
            const json = await res.json();

            select.innerHTML = "";
            json.sheetNames.forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });

            select.disabled = false;
            status.innerHTML = "âœ… ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ ì™„ë£Œ";

        } catch (err) {
            status.innerHTML = "âŒ ì‹œíŠ¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨";
        }
    }

    /***************************************************
     * 3) íŒŒì¼ ì—…ë¡œë“œ (Binary ê·¸ëŒ€ë¡œ ì „ì†¡)
     ***************************************************/
    async function uploadExcelFile() {
        if (!selectedFile) {
            showMessage("âŒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!", "error");
            return;
        }

        document.getElementById("uploadButton").disabled = true;
        updateProcess("ì—…ë¡œë“œ ì¤‘...");

        try {
            const res = await fetch(GAS_WEB_APP_URL, {
                method: "POST",
                body: selectedFile
            });

            const json = await res.json();

            if (json.success) {
                showMessage(`âœ… ì—…ë¡œë“œ ì„±ê³µ! (${json.rows}í–‰ ë³€í™˜)`, "success");
            } else {
                showMessage(`âŒ ì—…ë¡œë“œ ì˜¤ë¥˜: ${json.error}`, "error");
            }
        } catch (err) {
            showMessage(`âŒ ì„œë²„ ì˜¤ë¥˜: ${err.message}`, "error");
        } finally {
            updateProcess("", false);
            document.getElementById("uploadButton").disabled = false;
        }
    }

    /***************************************************
     * UI ë©”ì‹œì§€ í•¨ìˆ˜
     ***************************************************/
    function showMessage(msg, type = "info") {
        const box = document.getElementById("message-box");
        box.className = type;
        box.textContent = msg;
        box.style.display = "block";
        box.style.opacity = 1;

        setTimeout(() => {
            box.style.opacity = 0;
            setTimeout(() => (box.style.display = "none"), 300);
        }, 3000);
    }

    function updateProcess(message, show = true) {
        const el = document.getElementById("processIndicator");
        const msg = document.getElementById("currentProcessMessage");

        msg.textContent = message;
        el.classList.toggle("hidden", !show);
    }

    /***************************************************/
    window.onload = fetchSheetNames;
</script>
</body>
</html>
